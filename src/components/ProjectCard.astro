---
import { Image } from 'astro:assets';
import type { ImageMetadata } from 'astro';
import { cn } from '@/utils/tailwind';
import type { HTMLTag } from 'astro/types';

type Props = {
  as?: HTMLTag;
  class?: string;
  href?: string;
  heading?: string;
  subheading?: string;
  imagePath?: string; // "cover.jpg" o "/src/assets/cover.jpg"
  altText?: string;
  span?: number;
};

const {
  as: Tag = 'div',
  class: className,
  href,
  heading,
  subheading,
  imagePath,
  altText = '',
  span = 1,
} = Astro.props as Props;

const images = import.meta.glob<{ default: ImageMetadata }>(
  '/src/assets/*.{jpeg,jpg,png,gif}'
);

// Normaliza imagePath para que coincida con las keys del glob
const normalizedImagePath =
  imagePath &&
  (imagePath.startsWith('/src/assets/')
    ? imagePath
    : `/src/assets/${imagePath}`);

const imageLoader = normalizedImagePath
  ? images[normalizedImagePath]
  : undefined;

if (normalizedImagePath && !imageLoader) {
  throw new Error(
    `"${normalizedImagePath}" does not exist in glob: "/src/assets/*.{jpeg,jpg,png,gif}"`
  );
}

// Si hay href, renderiza un <a>; si no, usa el tag indicado (por defecto div)
const ActualTag: HTMLTag = href ? 'a' : Tag;
---

<ActualTag
  class={cn(
    className,
    'flex flex-col gap-y-3 rounded-2xl border border-border bg-primary-foreground',
    href && 'transition-all hover:border-foreground/25 hover:shadow-sm',
    span === 2 && 'md:col-span-2'
  )}
  {...href ? { href, target: '_blank', rel: 'noopener noreferrer' } : {}}
>
  {
    imageLoader && (
      <Image
        src={imageLoader()}
        alt={altText}
        class="h-48 w-full rounded-2xl rounded-bl-none rounded-br-none object-cover"
        loading="eager"
      />
    )
  }

  <div class="flex flex-col gap-y-0.5 px-5 py-4">
    {heading && <h1 class="text-lg font-medium">{heading}</h1>}
    {subheading && <h2 class="text-muted-foreground">{subheading}</h2>}
  </div>

  <slot />
</ActualTag>
